# DATA_MODEL.md

## Firestore Schema (Native Mode)
The system uses a parent-child relationship for chat persistence to optimize for high-concurrency and chronological retrieval.

### 1. `sessions` (Collection)
Root collection for unique chat instances.
- **Document ID:** `session_id` (UUID v4)
- **Fields:**
  - `created_at`: ServerTimestamp
  - `updated_at`: ServerTimestamp
  - `metadata`: Map (optional: user_agent, ip)

### 2. `sessions/{session_id}/messages` (Sub-collection)
Child collection containing the actual conversation turns.
- **Document ID:** Auto-generated by Firestore
- **Fields:**
  - `role`: string ("user" | "model")
  - `content`: string (Full message text)
  - `timestamp`: ServerTimestamp (used for ordering)
  - `metadata`: Map
    - `citations`: Array of URI strings (GCS links)
    - `idempotency_key`: string (UUID)
    - `model_version`: string (e.g., "gemini-3-flash-preview")

## Data Lifecycle
- **Retention:** 90-day TTL (Time To Live) is recommended for legal compliance.
- **Immutability:** Messages are **append-only**. Once a document is created in the `messages` collection, it MUST NOT be modified or deleted.