# CI_CD_AND_RELEASE.md

## Workflow Overview
The project uses GitHub Actions for continuous integration and deployment to Google Cloud Run.

### 1. Build Phase
- **Trigger:** Push to `main` or `develop` branches.
- **Action:** Builds a Docker image and pushes it to Google Cloud Build.
- **Tagging:** Images are tagged with the short SHA of the commit for traceability.

### 2. Runtime Orchestration
The container uses `entrypoint.sh` to manage startup:
1. Starts FastAPI (Backend) on port 8000.
2. Performs a health check loop until the Backend is ready.
3. Starts Streamlit (Frontend) on the system-defined `$PORT`.

### 3. Deployment Steps
- **Auth:** Uses `google-github-actions/auth` with a Service Account JSON key.
- **Cloud Run Deploy:** Configured with `allow_unauthenticated: true` and automated IAM policy binding.
- **Env Injection:** Parameters like `PROJECT_ID` and `DATA_STORE_ID` are injected dynamically from build-step outputs and GitHub secrets.

## Release Policy
- **Main:** Automated deployment to the `prod` service.
- **Develop:** Automated deployment to the `dev` service.
- **Rollback:** Achieved by re-deploying a previous known-good Docker image via Cloud Run revisions.

## Estrategia de Branching y Commits
- **Rama Principal:** `main` (Producción).
- **Rama de Desarrollo:** `develop` (Pruebas).
- **Commits Lógicos:** Se exige el estándar **Conventional Commits**.
  - Formato: `<tipo>(<alcance>): <descripción corta>`
  - Tipos: `feat`, `fix`, `docs`, `refactor`, `perf`, `chore`.
  - Ejemplo: `feat(api): add firestore persistence for chat sessions`.

## Gestión de Ambientes (GCP)
1. **Ambiente de Prueba (Testing):**
   - Trigger: Push a la rama `develop`.
   - Servicio: Cloud Run (Tag: `test`).
   - Firestore: Database `(default)` en proyecto de sandbox.
2. **Ambiente de Producción:**
   - Trigger: Release tag o merge a `main`.
   - Servicio: Cloud Run (Producción).
   - Firestore: Database dedicada con reglas de seguridad estrictas.

## Reglas Técnicas Obligatorias
- **No Direct Push:** Prohibido pushear directamente a `main`. Todo cambio pasa por PR.
- **Rollback:** Si el Health Check de Cloud Run falla en el despliegue, la revisión debe revertirse automáticamente